services:
  # Zookeeper - Required for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: globalmart-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - globalmart-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka - Message queue
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: globalmart-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
    networks:
      - globalmart-network
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 10s
      timeout: 10s
      retries: 5

  # PostgreSQL Data Warehouse - For batch processing
  postgres-warehouse:
    image: postgres:15-alpine
    container_name: globalmart-postgres-warehouse
    environment:
      POSTGRES_DB: ${POSTGRES_WAREHOUSE_DB}
      POSTGRES_USER: ${POSTGRES_WAREHOUSE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_WAREHOUSE_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres-warehouse-data:/var/lib/postgresql/data
      - ./batch_processing/schema/init_warehouse.sql:/docker-entrypoint-initdb.d/01-init_warehouse.sql
    networks:
      - globalmart-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_WAREHOUSE_USER} -d ${POSTGRES_WAREHOUSE_DB}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Real-Time - For stream processing
  postgres-realtime:
    image: postgres:15-alpine
    container_name: globalmart-postgres-realtime
    environment:
      POSTGRES_DB: ${POSTGRES_REALTIME_DB}
      POSTGRES_USER: ${POSTGRES_REALTIME_USER}
      POSTGRES_PASSWORD: ${POSTGRES_REALTIME_PASSWORD}
    ports:
      - "5433:5432" # Different host port to avoid conflict
    volumes:
      - postgres-realtime-data:/var/lib/postgresql/data
      - ./stream_processing/schema/init_realtime.sql:/docker-entrypoint-initdb.d/01-init_realtime.sql
    networks:
      - globalmart-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_REALTIME_USER} -d ${POSTGRES_REALTIME_DB}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB - Real-time metrics storage
  mongodb:
    image: mongo:7.0
    container_name: globalmart-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - globalmart-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Mongo Express - MongoDB web interface
  mongo-express:
    image: mongo-express:1.0-20
    container_name: globalmart-mongo-express
    depends_on:
      - mongodb
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_USER}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_PASSWORD}
    ports:
      - "8081:8081"
    networks:
      - globalmart-network
    restart: unless-stopped

  # Redis - Caching layer
  redis:
    image: redis:7-alpine
    container_name: globalmart-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - globalmart-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:10.2.3
    container_name: globalmart-grafana
    depends_on:
      - prometheus
      - postgres-warehouse
      - postgres-realtime
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      # PostgreSQL credentials for datasources
      POSTGRES_WAREHOUSE_USER: ${POSTGRES_WAREHOUSE_USER}
      POSTGRES_WAREHOUSE_PASSWORD: ${POSTGRES_WAREHOUSE_PASSWORD}
      POSTGRES_REALTIME_USER: ${POSTGRES_REALTIME_USER}
      POSTGRES_REALTIME_PASSWORD: ${POSTGRES_REALTIME_PASSWORD}
      # No MongoDB plugin - uses native PostgreSQL support instead
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./dashboards/grafana/provisioning:/etc/grafana/provisioning
    networks:
      - globalmart-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus - System monitoring
  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: globalmart-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - globalmart-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:9090/-/healthy",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Node Exporter - System metrics (CPU, Memory, Disk, Network)
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: globalmart-node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    pid: host
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - globalmart-network

  # Kafka Exporter - Kafka metrics
  kafka-exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: globalmart-kafka-exporter
    depends_on:
      kafka:
        condition: service_healthy
    command:
      - '--kafka.server=kafka:29092'
      - '--topic.filter=transactions-topic|cart-events-topic|product-views-topic'
      - '--group.filter=.*'
    networks:
      - globalmart-network
    restart: unless-stopped

  # Postgres Exporter - Warehouse database metrics
  postgres-exporter-warehouse:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: globalmart-postgres-exporter-warehouse
    depends_on:
      postgres-warehouse:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_WAREHOUSE_USER}:${POSTGRES_WAREHOUSE_PASSWORD}@postgres-warehouse:5432/${POSTGRES_WAREHOUSE_DB}?sslmode=disable"
    networks:
      - globalmart-network
    restart: unless-stopped

  # Postgres Exporter - Real-time database metrics
  postgres-exporter-realtime:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: globalmart-postgres-exporter-realtime
    depends_on:
      postgres-realtime:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_REALTIME_USER}:${POSTGRES_REALTIME_PASSWORD}@postgres-realtime:5432/${POSTGRES_REALTIME_DB}?sslmode=disable"
    networks:
      - globalmart-network
    restart: unless-stopped

  # Redis Exporter - Redis metrics
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: globalmart-redis-exporter
    depends_on:
      redis:
        condition: service_healthy
    environment:
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    networks:
      - globalmart-network
    restart: unless-stopped

volumes:
  postgres-warehouse-data:
    driver: local
  postgres-realtime-data:
    driver: local
  mongo-data:
    driver: local
  redis-data:
    driver: local
  grafana-data:
    driver: local
  prometheus-data:
    driver: local

networks:
  globalmart-network:
    driver: bridge
